name: Deploy AI Lambda to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'lambda/**'
      - 'terraform/**'
      - '.github/workflows/deploy-lambda.yml'
  
  pull_request:
    branches:
      - main
    paths:
      - 'lambda/**'
      - 'terraform/**'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '20.x'
  TERRAFORM_VERSION: '1.6.0'
  AWS_REGION: 'us-east-2'

jobs:
  # ============================================================
  # Job 1: Build and Test Lambda
  # ============================================================
  build-lambda:
    name: Build Lambda Function
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: lambda/package-lock.json
      
      - name: Install dependencies
        working-directory: ./lambda
        run: npm ci
      
      - name: Run TypeScript compilation
        working-directory: ./lambda
        run: npm run build
      
      - name: Run tests (if exist)
        working-directory: ./lambda
        run: npm test --if-present
      
      - name: Package Lambda
        working-directory: ./lambda
        run: |
          cd dist
          zip -r ../function.zip .
          cd ..
          ls -lh function.zip
      
      - name: Upload Lambda artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-function
          path: lambda/function.zip
          retention-days: 1

  # ============================================================
  # Job 2: Terraform Plan
  # ============================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: build-lambda
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-function
          path: lambda/
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init
      
      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check
        continue-on-error: true
      
      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate
      
      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="openai_api_key=${{ secrets.OPENAI_API_KEY }}" \
            -var="default_ai_model=${{ vars.DEFAULT_AI_MODEL || 'gpt-3.5-turbo' }}" \
            -var="environment=${{ github.event.inputs.environment || 'dev' }}" \
            -out=tfplan
      
      - name: Upload Terraform plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 1

  # ============================================================
  # Job 3: Deploy to AWS (only on main branch)
  # ============================================================
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build-lambda, terraform-plan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.api_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Lambda artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-function
          path: lambda/
      
      - name: Download Terraform plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init
      
      - name: Clean existing resources (dev only)
        if: vars.ENVIRONMENT == 'dev' || github.event.inputs.environment == 'dev'
        run: |
          # Eliminar Lambda si existe
          aws lambda delete-function \
            --function-name mobile-accenture-dev-ai-proxy \
            --region ${{ env.AWS_REGION }} \
            2>/dev/null || echo "Lambda no existe"
          
          # Eliminar IAM Role policies y role
          aws iam detach-role-policy \
            --role-name mobile-accenture-dev-ai-proxy-lambda-role \
            --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole \
            2>/dev/null || true
          
          aws iam delete-role \
            --role-name mobile-accenture-dev-ai-proxy-lambda-role \
            2>/dev/null || echo "IAM Role no existe"
          
          # Eliminar Log Groups
          aws logs delete-log-group \
            --log-group-name /aws/lambda/mobile-accenture-dev-ai-proxy \
            --region ${{ env.AWS_REGION }} \
            2>/dev/null || echo "Lambda Log Group no existe"
          
          aws logs delete-log-group \
            --log-group-name /aws/apigateway/mobile-accenture-dev-ai-proxy \
            --region ${{ env.AWS_REGION }} \
            2>/dev/null || echo "API Gateway Log Group no existe"
          
          # Eliminar API Gateway (si existe anterior)
          APIS=$(aws apigatewayv2 get-apis --region ${{ env.AWS_REGION }} --query "Items[?Name=='mobile-accenture-dev-ai-proxy-api'].ApiId" --output text)
          for API_ID in $APIS; do
            echo "Eliminando API Gateway: $API_ID"
            aws apigatewayv2 delete-api --api-id $API_ID --region ${{ env.AWS_REGION }} || true
          done
          
          echo "Recursos existentes eliminados, esperando 10 segundos..."
          sleep 10
      
      - name: Terraform Apply
        id: deploy
        working-directory: ./terraform
        run: |
          terraform apply -auto-approve tfplan
          
          # Capturar outputs
          API_ENDPOINT=$(terraform output -raw suggest_endpoint)
          echo "api_url=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Endpoint:** \`$API_ENDPOINT\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Test deployed endpoint
        run: |
          SUGGEST_ENDPOINT=$(cd terraform && terraform output -raw suggest_endpoint)
          HEALTH_ENDPOINT=$(cd terraform && terraform output -raw health_endpoint)
          
          echo "Testing health endpoint: $HEALTH_ENDPOINT"
          
          # Health check
          curl -f "$HEALTH_ENDPOINT" || exit 1
          
          echo "Testing suggestion endpoint: $SUGGEST_ENDPOINT"
          
          # Test suggestion
          RESPONSE=$(curl -s -X POST "$SUGGEST_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d '{"categoryName": "Test from CI/CD"}')
          
          echo "Response: $RESPONSE"
          
          # Verificar que tiene los campos esperados
          echo "$RESPONSE" | jq -e '.icon' > /dev/null || exit 1
          echo "$RESPONSE" | jq -e '.color' > /dev/null || exit 1
      
      - name: Comment PR with deployment info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### ðŸš€ Lambda Deployment Preview
            
            **Status:** âœ… Success
            **Environment:** ${{ github.event.inputs.environment || 'dev' }}
            **API Endpoint:** \`${{ steps.deploy.outputs.api_url }}\`
            
            **Health Check:**
            \`\`\`
            curl ${{ steps.deploy.outputs.api_url }}/../health
            \`\`\`
            
            **Test Suggestion:**
            \`\`\`bash
            curl -X POST ${{ steps.deploy.outputs.api_url }} \\
              -H "Content-Type: application/json" \\
              -d '{"categoryName": "Trabajo"}'
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ============================================================
  # Job 4: Cleanup on failure
  # ============================================================
  cleanup:
    name: Cleanup artifacts
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            lambda-function
            terraform-plan
