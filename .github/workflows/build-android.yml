name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Ionic CLI and Cordova
      run: |
        npm install -g @ionic/cli
        npm install -g cordova
    
    - name: Install dependencies
      run: npm ci
    
    - name: Set environment variables
      run: |
        export FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY }}"
        export FIREBASE_AUTH_DOMAIN="${{ secrets.FIREBASE_AUTH_DOMAIN }}"
        export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
        export FIREBASE_STORAGE_BUCKET="${{ secrets.FIREBASE_STORAGE_BUCKET }}"
        export FIREBASE_MESSAGING_SENDER_ID="${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}"
        export FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}"
        export AI_PROXY_URL="${{ secrets.AI_PROXY_URL }}"
        export NODE_ENV=production
        npm run config:env:prod
    
    - name: Build aplicaciÃ³n web
      run: ionic build --prod
    
    - name: AÃ±adir plataforma Android
      run: ionic cordova platform add android --no-interactive
    
    - name: Build APK sin firma (debug)
      run: ionic cordova build android --no-interactive
    
    - name: Verificar APK generado
      run: |
        echo "ðŸ“± APK generado en:"
        find platforms/android/app/build/outputs/apk -name "*.apk" -type f
        ls -lh platforms/android/app/build/outputs/apk/debug/*.apk
    
    - name: Renombrar APK
      run: |
        cd platforms/android/app/build/outputs/apk/debug
        mv app-debug.apk TodoApp-${{ github.sha }}.apk
    
    - name: Subir APK como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-debug
        path: platforms/android/app/build/outputs/apk/debug/TodoApp-*.apk
        retention-days: 30
    
    - name: Mostrar informaciÃ³n del APK
      run: |
        echo "âœ… APK generado exitosamente"
        echo "ðŸ“Š TamaÃ±o del APK:"
        du -h platforms/android/app/build/outputs/apk/debug/TodoApp-*.apk
        echo "ðŸ”— Descarga el APK desde la pestaÃ±a 'Actions' de este workflow"
