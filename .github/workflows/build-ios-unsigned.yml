name: Build iOS IPA (Sin Firma)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Ionic CLI and Cordova
      run: |
        npm install -g @ionic/cli
        npm install -g cordova
    
    - name: Install dependencies
      run: npm ci
    
    - name: Set environment variables
      run: |
        export FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY }}"
        export FIREBASE_AUTH_DOMAIN="${{ secrets.FIREBASE_AUTH_DOMAIN }}"
        export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
        export FIREBASE_STORAGE_BUCKET="${{ secrets.FIREBASE_STORAGE_BUCKET }}"
        export FIREBASE_MESSAGING_SENDER_ID="${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}"
        export FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}"
        export AI_PROXY_URL="${{ secrets.AI_PROXY_URL }}"
        export NODE_ENV=production
        npm run config:env:prod
    
    - name: Build aplicaciÃ³n web
      run: npm run build:prod
    
    - name: AÃ±adir plataforma iOS
      run: npx cordova platform add ios --no-interactive
    
    - name: Configurar deployment target iOS 12.0
      run: |
        cd platforms/ios
        echo "ðŸ”§ Configurando iOS deployment target a 12.0..."
        
        # Buscar y actualizar todos los archivos project.pbxproj
        find . -name "project.pbxproj" -type f | while read file; do
          if [ -f "$file" ]; then
            echo "Actualizando $file"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 11\.0;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/g' "$file"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 10\.0;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/g' "$file"
            sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 9\.0;/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/g' "$file"
          fi
        done
    
    - name: Compilar Xcode sin firma
      run: |
        cd platforms/ios
        echo "ðŸ”¨ Compilando proyecto iOS sin firma de cÃ³digo..."
        xcodebuild -workspace *.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -sdk iphoneos \
                   CODE_SIGNING_ALLOWED=NO \
                   CODE_SIGNING_REQUIRED=NO \
                   ENTITLEMENTS_REQUIRED=NO \
                   IPHONEOS_DEPLOYMENT_TARGET=12.0 \
                   SWIFT_OPTIMIZATION_LEVEL=-Onone \
                   clean build
    
    - name: Verificar .app generado
      run: |
        echo "ðŸ“± Verificando archivo .app generado:"
        find platforms/ios/build/Release-iphoneos -name "*.app" -type d
        ls -lh platforms/ios/build/Release-iphoneos/
    
    - name: Empaquetar en IPA
      run: |
        echo "ðŸ“¦ Creando estructura IPA..."
        mkdir -p build/Payload
        
        # Copiar .app a Payload
        APP_NAME=$(find platforms/ios/build/Release-iphoneos -name "*.app" -type d -maxdepth 1 | head -n 1)
        if [ -z "$APP_NAME" ]; then
          echo "âŒ Error: No se encontrÃ³ archivo .app"
          exit 1
        fi
        
        echo "ðŸ“± Copiando $APP_NAME"
        cp -r "$APP_NAME" build/Payload/
        
        # Crear IPA
        cd build
        IPA_NAME="TodoApp_Unsigned_iOS.ipa"
        zip -r "$IPA_NAME" Payload
        
        echo "âœ… IPA creado: $IPA_NAME"
        echo "ðŸ“Š TamaÃ±o: $(du -h "$IPA_NAME" | cut -f1)"
    
    - name: Subir IPA como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-unsigned
        path: build/TodoApp_Unsigned_iOS.ipa
        retention-days: 30
    
    - name: Crear documentaciÃ³n para evaluadores
      run: |
        cat > build/INSTRUCCIONES_IPA.md << 'EOF'
        # Instrucciones para el IPA sin firma
        
        ## âš ï¸ Â¿Por quÃ© no estÃ¡ firmado?
        
        Este IPA no incluye firma de cÃ³digo porque requiere:
        - Cuenta de Apple Developer ($99/aÃ±o)
        - Certificados de distribuciÃ³n
        - UUIDs de dispositivos especÃ­ficos
        
        ## âœ… Contenido del IPA
        
        El IPA incluye:
        - âœ… CÃ³digo compilado de la aplicaciÃ³n
        - âœ… Assets (imÃ¡genes, iconos, splash screens)
        - âœ… ConfiguraciÃ³n de la app
        - âœ… Todos los recursos necesarios
        - âŒ Firma de cÃ³digo (requiere cuenta Apple Developer)
        
        ## ðŸ”§ Â¿CÃ³mo instalar el IPA?
        
        ### OpciÃ³n 1: Re-firmar con sus propios certificados
        
        Si tienen cuenta Apple Developer, pueden re-firmar:
        ```bash
        # Usando herramientas de firma
        ios-app-signer --input TodoApp_Unsigned_iOS.ipa --output TodoApp_Signed.ipa
        ```
        
        ### OpciÃ³n 2: Instalar desde cÃ³digo fuente
        
        El cÃ³digo fuente completo estÃ¡ en el repositorio:
        ```bash
        git clone https://github.com/johssalinas/mobile-accenture
        cd mobile-accenture
        npm install
        ionic cordova build ios --prod
        # Abrir en Xcode y firmar con su cuenta
        open platforms/ios/*.xcworkspace
        ```
        
        ### OpciÃ³n 3: Verificar contenido del IPA
        
        ```bash
        # Extraer contenido
        unzip TodoApp_Unsigned_iOS.ipa
        cd Payload/*.app
        
        # Revisar recursos, assets, configuraciÃ³n
        ls -la
        ```
        
        ## ðŸ“‹ InformaciÃ³n tÃ©cnica
        
        - **Min iOS**: 13.0
        - **Target iOS**: 17.0
        - **Arquitectura**: arm64 (iPhone universal)
        - **ConfiguraciÃ³n**: Release
        - **Framework**: Ionic + Angular + Cordova
        
        ## ðŸ”— Recursos
        
        - [Repositorio](https://github.com/johssalinas/mobile-accenture)
        - [DocumentaciÃ³n completa](https://github.com/johssalinas/mobile-accenture/blob/main/docs/GITHUB_ACTIONS_ANDROID.md)
        EOF
        
        echo "âœ… DocumentaciÃ³n creada"
    
    - name: Subir documentaciÃ³n
      uses: actions/upload-artifact@v4
      with:
        name: ios-instrucciones
        path: build/INSTRUCCIONES_IPA.md
        retention-days: 30
    
    - name: Mostrar resumen
      run: |
        echo ""
        echo "âœ… IPA generado exitosamente (SIN FIRMA)"
        echo ""
        echo "ðŸ“± Archivo: TodoApp_Unsigned_iOS.ipa"
        echo "ðŸ“Š TamaÃ±o: $(du -h build/TodoApp_Unsigned_iOS.ipa | cut -f1)"
        echo ""
        echo "âš ï¸  IMPORTANTE:"
        echo "   - Este IPA NO estÃ¡ firmado"
        echo "   - NO se puede instalar directamente en dispositivos iOS"
        echo "   - Requiere re-firma con certificados de Apple Developer"
        echo "   - Demuestra que el cÃ³digo iOS compila correctamente"
        echo ""
        echo "ðŸ”— Descarga desde:"
        echo "   Actions â†’ Este workflow â†’ Artifacts â†’ ios-app-unsigned"
        echo ""
        echo "ðŸ“– Lee INSTRUCCIONES_IPA.md para mÃ¡s informaciÃ³n"
