name: Build iOS App (Simulador)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios-simulator:
    runs-on: macos-latest
    
    steps:
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install Ionic CLI and Cordova
      run: |
        npm install -g @ionic/cli
        npm install -g cordova
    
    - name: Install dependencies
      run: npm ci
    
    - name: Set environment variables
      run: |
        export FIREBASE_API_KEY="${{ secrets.FIREBASE_API_KEY }}"
        export FIREBASE_AUTH_DOMAIN="${{ secrets.FIREBASE_AUTH_DOMAIN }}"
        export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
        export FIREBASE_STORAGE_BUCKET="${{ secrets.FIREBASE_STORAGE_BUCKET }}"
        export FIREBASE_MESSAGING_SENDER_ID="${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}"
        export FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}"
        export AI_PROXY_URL="${{ secrets.AI_PROXY_URL }}"
        export NODE_ENV=production
        npm run config:env:prod
    
    - name: Build aplicaciÃ³n web
      run: npm run build:prod
    
    - name: AÃ±adir plataforma iOS
      run: npx cordova platform add ios --no-interactive
    
    - name: Compilar para iOS Simulator
      run: |
        cd platforms/ios
        echo "ðŸ”¨ Compilando para iOS Simulator (no requiere firma)..."
        
        xcodebuild -workspace *.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -sdk iphonesimulator \
                   -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
                   build
        
        echo "âœ… CompilaciÃ³n completada"
    
    - name: Verificar y empaquetar .app
      run: |
        echo "ðŸ“± Buscando archivo .app generado..."
        cd platforms/ios
        
        APP_PATH=$(find . -path "*/Release-iphonesimulator/*.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ No se encontrÃ³ .app para simulador"
          find . -name "*.app" -type d
          exit 1
        fi
        
        echo "âœ… Encontrado: $APP_PATH"
        
        # Crear estructura para "IPA" (realmente es .app comprimido para simulador)
        cd ../..
        mkdir -p build
        cp -r "platforms/ios/$APP_PATH" build/
        
        APP_NAME=$(basename "$APP_PATH")
        cd build
        zip -r "TodoApp_Simulator.zip" "$APP_NAME"
        
        echo "âœ… App para simulador empaquetada"
        ls -lh TodoApp_Simulator.zip
    
    - name: Subir app como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-simulator
        path: build/TodoApp_Simulator.zip
        retention-days: 30
    
    - name: Crear documentaciÃ³n
      run: |
        cat > build/INSTRUCCIONES_iOS.md << 'EOF'
        # App iOS para Simulador
        
        ## â„¹ï¸ InformaciÃ³n
        
        Esta aplicaciÃ³n fue compilada para **iOS Simulator**, no para dispositivos fÃ­sicos.
        
        ### Â¿Por quÃ© simulador?
        
        - No requiere cuenta Apple Developer ($99/aÃ±o)
        - No necesita certificados de firma
        - Permite demostraciÃ³n tÃ©cnica del cÃ³digo iOS
        
        ### Â¿CÃ³mo usar?
        
        1. Descomprimir `TodoApp_Simulator.zip`
        2. Arrastra el archivo `.app` al Simulator de Xcode
        3. O usa: `xcrun simctl install booted path/to/App.app`
        
        ### Para dispositivos fÃ­sicos
        
        El cÃ³digo fuente estÃ¡ disponible en el repositorio.
        Con cuenta Apple Developer puedes:
        ```bash
        open platforms/ios/*.xcworkspace
        # Firmar en Xcode y exportar IPA
        ```
        
        ## Contenido
        
        - âœ… CÃ³digo compilado (arm64 simulator)
        - âœ… Assets y recursos
        - âœ… ConfiguraciÃ³n completa
        - âš ï¸ Solo funciona en Simulator, no en dispositivos reales
        EOF
    
    - name: Subir documentaciÃ³n
      uses: actions/upload-artifact@v4
      with:
        name: ios-instrucciones
        path: build/INSTRUCCIONES_iOS.md
        retention-days: 30
    
    - name: Resumen
      run: |
        echo "âœ… Build de iOS Simulator completado"
        echo "ðŸ“¦ Artefactos generados:"
        echo "   - ios-app-simulator: App para iOS Simulator"
        echo "   - ios-instrucciones: DocumentaciÃ³n de uso"
        echo ""
        echo "âš ï¸  NOTA: Esta app funciona solo en iOS Simulator"
        echo "Para dispositivos reales se requiere cuenta Apple Developer"
